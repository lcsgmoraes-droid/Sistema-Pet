import{u as Ge,p as $e,r as i,j as e}from"./vendor-react-1771887373071.js";import{a as Ke}from"./vendor-utils-1771887373071.js";const We="/api",Ye=We,p=Ke.create({baseURL:Ye,timeout:15e3,headers:{"Content-Type":"application/json"}});p.interceptors.request.use(o=>{const u=String(o.baseURL||""),f=String(o.url||"");return u.endsWith("/api")&&f.startsWith("/api/")&&(o.url=f.replace(/^\/api/,"")),o});const N="ecommerce_customer_token",Ce="ecommerce_customer_orders",we="ecommerce_customer_address",ae="ecommerce_guest_cart",R={pedido_id:null,itens:[],subtotal:0,total:0};function j(o){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(o||0))}function Z(o){return Number((o==null?void 0:o.preco_venda)??(o==null?void 0:o.preco)??(o==null?void 0:o.preco_promocional)??0)}function Je(){var o;return(o=window==null?void 0:window.crypto)!=null&&o.randomUUID?window.crypto.randomUUID():`checkout-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Ve(o){return Array.isArray(o)?o:Array.isArray(o==null?void 0:o.items)?o.items:Array.isArray(o==null?void 0:o.itens)?o.itens:Array.isArray(o==null?void 0:o.produtos)?o.produtos:[]}function H(){try{const o=localStorage.getItem(ae);if(!o)return{...R};const u=JSON.parse(o);if(!Array.isArray(u==null?void 0:u.itens))return{...R};const f=Number((u==null?void 0:u.subtotal)||0),h=Number((u==null?void 0:u.total)||0);return{pedido_id:null,itens:u.itens,subtotal:f,total:h}}catch{return{...R}}}function ee(o){const u=o.reduce((f,h)=>f+Number(h.preco_unitario||0)*Number(h.quantidade||0),0);return{pedido_id:null,itens:o,subtotal:u,total:u}}function Ze(){var je,ve,Se,_e;const o=Ge(),u=$e(),[f,h]=i.useState("loja"),[M,te]=i.useState(!1),[T,G]=i.useState([]),[A,Re]=i.useState(""),[L,Ee]=i.useState("todas"),[y,re]=i.useState(null),[se,I]=i.useState(!1),[ne,oe]=i.useState(!1),[Ne,ie]=i.useState(!1),[m,z]=i.useState(localStorage.getItem(N)||""),[U,$]=i.useState(null),[B,D]=i.useState({email:"",password:"",nome:""}),[K,W]=i.useState({email:"",password:""}),[g,v]=i.useState(()=>H()),[Y,de]=i.useState(""),[S,J]=i.useState(null),[F,Te]=i.useState(""),[P,Ae]=i.useState(localStorage.getItem(we)||""),[b,q]=i.useState(null),[O,V]=i.useState(null),[E,Le]=i.useState(()=>{try{return JSON.parse(localStorage.getItem(Ce)||"[]")}catch{return[]}}),[ce,le]=i.useState({}),[ue,d]=i.useState(""),[he,x]=i.useState(""),[c,Q]=i.useState(null),C=i.useMemo(()=>new URLSearchParams(o.search).get("tenant")||u.tenantId||"",[o.search,u.tenantId]),me=i.useMemo(()=>c!=null&&c.id?{"X-Tenant-ID":c.id}:{},[c==null?void 0:c.id]),_=i.useMemo(()=>m?{Authorization:`Bearer ${m}`}:{},[m]),Ie=i.useMemo(()=>{const a=T.map(t=>(t==null?void 0:t.categoria_nome)||(t==null?void 0:t.categoria)||"Sem categoria").filter(Boolean);return["todas",...Array.from(new Set(a))]},[T]),ge=i.useMemo(()=>{const a=A.trim().toLowerCase();return T.filter(t=>{const r=String((t==null?void 0:t.nome)||"").toLowerCase(),n=(t==null?void 0:t.categoria_nome)||(t==null?void 0:t.categoria)||"Sem categoria";return(!a||r.includes(a))&&(L==="todas"||n===L)})},[T,A,L]);i.useEffect(()=>{if(!C){G([]),Q(null),d("Loja não informada na URL. Use /slug-da-loja.");return}ze(),pe()},[C]),i.useEffect(()=>{m&&(Ue(),fe())},[m]),i.useEffect(()=>{m||localStorage.setItem(ae,JSON.stringify(g||R))},[g,m]);async function ze(){var a,t;try{const r=await p.get("/api/ecommerce/tenant-context",{params:{tenant:C}});Q((r==null?void 0:r.data)||null)}catch(r){Q(null),d(((t=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:t.detail)||"Loja inválida para e-commerce")}}async function pe(){var a,t;if(C){te(!0),d("");try{const r=await p.get("/api/ecommerce/produtos",{params:{tenant:C,limit:100,busca:A||void 0}});G(Ve(r==null?void 0:r.data))}catch(r){G([]),d(((t=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:t.detail)||"Erro ao carregar produtos vendáveis")}finally{te(!1)}}}async function Ue(){if(m)try{const a=await p.get("/api/ecommerce/auth/me",{headers:_});$(a.data)}catch{$(null),z(""),localStorage.removeItem(N),v(H())}}async function fe(a=_){var t,r;if(a!=null&&a.Authorization){ie(!0);try{const n=await p.get("/api/carrinho",{headers:a});v(n.data||{...R})}catch(n){d(((r=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:r.detail)||"Erro ao carregar carrinho")}finally{ie(!1)}}}async function ye(a){var n;const t=H();if(!((n=t==null?void 0:t.itens)!=null&&n.length))return;const r={Authorization:`Bearer ${a}`};for(const s of t.itens)await p.post("/api/carrinho/adicionar",{produto_id:s.produto_id,quantidade:s.quantidade},{headers:r});await fe(r),localStorage.removeItem(ae)}async function Be(a){var t,r,n;if(a.preventDefault(),!(c!=null&&c.id)){d("Loja não identificada na URL.");return}I(!0),d(""),x("");try{const s=await p.post("/api/ecommerce/auth/registrar",B,{headers:me}),l=(t=s==null?void 0:s.data)==null?void 0:t.access_token;if(!l)throw new Error("Token não retornado");localStorage.setItem(N,l),z(l),await ye(l),D({email:"",password:"",nome:""}),x("Cadastro realizado com sucesso."),h("loja")}catch(s){d(((n=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:n.detail)||"Erro ao cadastrar cliente")}finally{I(!1)}}async function De(a){var t,r,n;if(a.preventDefault(),!(c!=null&&c.id)){d("Loja não identificada na URL.");return}I(!0),d(""),x("");try{const s=await p.post("/api/ecommerce/auth/login",K,{headers:me}),l=(t=s==null?void 0:s.data)==null?void 0:t.access_token;if(!l)throw new Error("Token não retornado");localStorage.setItem(N,l),z(l),await ye(l),W({email:"",password:""}),x("Login realizado com sucesso."),h("loja")}catch(s){d(((n=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:n.detail)||"Erro ao realizar login")}finally{I(!1)}}function Fe(){$(null),z(""),v({...R}),q(null),V(null),localStorage.removeItem(N),x("Sessão encerrada.")}async function xe(a){var t,r;if(!m){d("");const n=Z(a);v(s=>{const l=Array.isArray(s==null?void 0:s.itens)?s.itens:[],w=l.find(k=>k.produto_id===a.id)?l.map(k=>k.produto_id===a.id?{...k,quantidade:Number(k.quantidade||0)+1}:k):[...l,{item_id:`guest-${a.id}`,produto_id:a.id,nome:a.nome,preco_unitario:n,quantidade:1}];return ee(w)}),x("Produto adicionado ao carrinho. Faça login no checkout para finalizar.");return}d("");try{const n=await p.post("/api/carrinho/adicionar",{produto_id:a.id,quantidade:1},{headers:_});v(n.data),x("Produto adicionado ao carrinho.")}catch(n){d(((r=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:r.detail)||"Erro ao adicionar no carrinho")}}async function X(a,t){var r,n;if(!m){v(s=>{const l=Array.isArray(s==null?void 0:s.itens)?s.itens:[];if(t<=0){const w=l.filter(k=>k.item_id!==a);return ee(w)}const ke=l.map(w=>w.item_id===a?{...w,quantidade:t}:w);return ee(ke)});return}d("");try{if(t<=0){const l=await p.delete(`/api/carrinho/remover/${a}`,{headers:_});v(l.data);return}const s=await p.put(`/api/carrinho/atualizar/${a}`,{quantidade:t},{headers:_});v(s.data)}catch(s){d(((n=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:n.detail)||"Erro ao atualizar carrinho")}}async function Pe(a){var t,r;if(a.preventDefault(),!m){d("Faça login para aplicar cupom."),h("conta");return}if(Y.trim()){d("");try{const n=await p.post("/api/carrinho/aplicar-cupom",{codigo:Y.trim()},{headers:_});J(n.data),x("Cupom validado.")}catch(n){J(null),d(((r=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:r.detail)||"Cupom inválido")}}}async function qe(a){var t,r,n;if(a.preventDefault(),!m){d("Faça login para continuar no checkout."),h("conta");return}if(!((t=g==null?void 0:g.itens)!=null&&t.length)){d("Adicione itens no carrinho antes de calcular o checkout.");return}d(""),q(null);try{const s=await p.get("/api/checkout/resumo",{headers:_,params:{cidade_destino:F,cupom:(S==null?void 0:S.codigo)||void 0}});q(s.data),x("Resumo de checkout calculado.")}catch(s){d(((n=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:n.detail)||"Erro ao calcular resumo do checkout")}}async function Oe(){var a,t;if(!m){d("Faça login para finalizar o pedido."),h("conta");return}oe(!0),d(""),x(""),V(null);try{const n=(await p.post("/api/checkout/finalizar",{cidade_destino:F,endereco_entrega:P||null,cupom:(S==null?void 0:S.codigo)||null},{headers:{..._,"Idempotency-Key":Je()}})).data;if(V(n),v({pedido_id:null,itens:[],subtotal:0,total:0}),q(null),J(null),de(""),P&&localStorage.setItem(we,P),n!=null&&n.pedido_id){const s=Array.from(new Set([n.pedido_id,...E]));Le(s),localStorage.setItem(Ce,JSON.stringify(s))}x("Pedido finalizado com sucesso."),h("pedidos")}catch(r){d(((t=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:t.detail)||"Erro ao finalizar checkout")}finally{oe(!1)}}async function be(a){if(!(!m||!a))try{const t=await p.get(`/api/checkout/pedido/${a}/status`,{headers:_});le(r=>({...r,[a]:t.data}))}catch(t){le(r=>{var n,s;return{...r,[a]:{status:"erro",detail:((s=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:s.detail)||"Erro ao consultar pedido"}}})}}i.useEffect(()=>{!m||f!=="pedidos"||E.slice(0,10).forEach(a=>{ce[a]||be(a)})},[f,m,E]);const Me=Number((g==null?void 0:g.total)||0);return e.jsxs("div",{className:"page",children:[e.jsx("h1",{children:"E-commerce MVP"}),e.jsx("p",{style:{color:"#666",marginBottom:16},children:"Loja, carrinho, checkout e conta do cliente no fluxo do e-commerce."}),e.jsxs("div",{style:{marginBottom:12,color:c!=null&&c.id?"#0a7d32":"#b00020"},children:["Loja: ",(c==null?void 0:c.name)||"não identificada"," (",(c==null?void 0:c.ecommerce_slug)||C||"-",")"]}),(c==null?void 0:c.storefront_path)&&e.jsxs("div",{style:{marginBottom:12,color:"#4b5563"},children:["URL da loja: ",c.storefront_path]}),!C&&e.jsx("div",{style:{marginBottom:12,color:"#b00020"},children:"Use a URL no formato: /slug-da-loja"}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginBottom:16},children:[e.jsx("button",{className:"btn-secondary",onClick:()=>h("loja"),children:"Loja"}),e.jsx("button",{className:"btn-secondary",onClick:()=>h("carrinho"),children:"Carrinho"}),e.jsx("button",{className:"btn-secondary",onClick:()=>h("checkout"),children:"Checkout"}),e.jsx("button",{className:"btn-secondary",onClick:()=>h("pedidos"),children:"Meus pedidos"}),e.jsx("button",{className:"btn-secondary",onClick:()=>h("conta"),children:"Conta"})]}),ue&&e.jsx("div",{style:{background:"#ffe8e8",color:"#8c0000",padding:10,borderRadius:6,marginBottom:12},children:ue}),he&&e.jsx("div",{style:{background:"#e8fff0",color:"#0a7d32",padding:10,borderRadius:6,marginBottom:12},children:he}),f==="loja"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:12},children:[e.jsx("input",{value:A,onChange:a=>Re(a.target.value),placeholder:"Buscar produto...",style:{flex:1,padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("select",{value:L,onChange:a=>Ee(a.target.value),style:{padding:8,border:"1px solid #ddd",borderRadius:6},children:Ie.map(a=>e.jsx("option",{value:a,children:a},a))}),e.jsx("button",{className:"btn-secondary",onClick:pe,disabled:M,children:M?"Carregando...":"Atualizar"})]}),e.jsxs("div",{style:{display:"grid",gap:8},children:[ge.map(a=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",border:"1px solid #eee",borderRadius:6,padding:10},children:[e.jsxs("div",{children:[e.jsx("strong",{children:a.nome}),e.jsxs("div",{style:{fontSize:12,color:"#666"},children:["Categoria: ",(a==null?void 0:a.categoria_nome)||(a==null?void 0:a.categoria)||"Sem categoria"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>re(a),style:{marginTop:6},children:"Ver produto"})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{marginBottom:6},children:j(Z(a))}),e.jsx("button",{className:"btn-primary",onClick:()=>xe(a),children:"Adicionar"})]})]},a.id)),!M&&ge.length===0&&e.jsx("div",{style:{color:"#666",padding:12,display:"grid",gap:10},children:e.jsx("div",{children:"Nenhum produto encontrado para o filtro atual."})})]}),y&&e.jsxs("div",{style:{marginTop:14,border:"1px solid #e2e8f0",borderRadius:8,padding:12,background:"#f8fafc"},children:[e.jsx("h3",{style:{marginTop:0},children:y.nome}),e.jsxs("div",{children:["Preço: ",e.jsx("strong",{children:j(Z(y))})]}),e.jsxs("div",{children:["Categoria: ",(y==null?void 0:y.categoria_nome)||(y==null?void 0:y.categoria)||"Sem categoria"]}),e.jsxs("div",{children:["Estoque e-commerce: ",(y==null?void 0:y.estoque_ecommerce)??0]}),e.jsxs("div",{style:{marginTop:8},children:[e.jsx("button",{className:"btn-primary",onClick:()=>xe(y),children:"Adicionar ao carrinho"}),e.jsx("button",{className:"btn-secondary",onClick:()=>re(null),style:{marginLeft:8},children:"Fechar"})]})]})]}),f==="carrinho"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Carrinho"}),Ne?e.jsx("div",{children:"Carregando carrinho..."}):(je=g==null?void 0:g.itens)!=null&&je.length?e.jsxs("div",{style:{display:"grid",gap:8},children:[g.itens.map(a=>e.jsxs("div",{style:{border:"1px solid #eee",borderRadius:6,padding:8},children:[e.jsx("div",{style:{fontWeight:600},children:a.nome}),e.jsx("div",{style:{fontSize:12,color:"#666"},children:j(a.preco_unitario)}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:6},children:[e.jsx("button",{className:"btn-secondary",onClick:()=>X(a.item_id,a.quantidade-1),children:"-"}),e.jsx("span",{children:a.quantidade}),e.jsx("button",{className:"btn-secondary",onClick:()=>X(a.item_id,a.quantidade+1),children:"+"}),e.jsx("button",{className:"btn-secondary",onClick:()=>X(a.item_id,0),children:"Remover"})]})]},a.item_id)),e.jsxs("div",{style:{marginTop:8,fontWeight:700},children:["Total: ",j(Me)]})]}):e.jsx("div",{style:{color:"#666"},children:"Carrinho vazio"}),e.jsxs("form",{onSubmit:Pe,style:{marginTop:12,display:"flex",gap:8},children:[e.jsx("input",{value:Y,onChange:a=>de(a.target.value),placeholder:"Cupom",style:{flex:1,padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-secondary",type:"submit",children:"Aplicar"})]}),S&&e.jsxs("div",{style:{marginTop:8,color:"#0a7d32"},children:["Cupom ",S.codigo,": -",j(S.desconto)]})]}),f==="checkout"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8,display:"grid",gap:10},children:[e.jsx("h3",{style:{marginTop:0},children:"Checkout"}),e.jsxs("form",{onSubmit:qe,style:{display:"grid",gap:8},children:[e.jsx("input",{value:F,onChange:a=>Te(a.target.value),placeholder:"Cidade de destino",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:P,onChange:a=>Ae(a.target.value),placeholder:"Endereço de entrega",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-secondary",type:"submit",children:"Calcular resumo"})]}),b&&e.jsxs("div",{style:{background:"#f8fafc",border:"1px solid #e2e8f0",borderRadius:8,padding:10},children:[e.jsxs("div",{children:["Itens: ",b.itens_count]}),e.jsxs("div",{children:["Subtotal: ",j(b.subtotal)]}),e.jsxs("div",{children:["Frete: ",j((ve=b==null?void 0:b.frete)==null?void 0:ve.valor_frete)]}),e.jsxs("div",{children:["Desconto: ",j((Se=b==null?void 0:b.cupom)==null?void 0:Se.desconto)]}),e.jsxs("div",{style:{fontWeight:700},children:["Total: ",j(b.total)]})]}),e.jsx("button",{className:"btn-primary",onClick:Oe,disabled:ne||!F||!((_e=g==null?void 0:g.itens)!=null&&_e.length),children:ne?"Finalizando...":"Finalizar pedido"}),(O==null?void 0:O.pedido_id)&&e.jsxs("div",{style:{background:"#e8fff0",color:"#0a7d32",padding:10,borderRadius:6},children:["Pedido confirmado: ",e.jsx("strong",{children:O.pedido_id})]})]}),f==="pedidos"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Meus pedidos"}),E.length===0?e.jsx("div",{style:{color:"#666"},children:"Nenhum pedido registrado nesta sessão."}):e.jsx("div",{style:{display:"grid",gap:8},children:E.map(a=>{const t=ce[a];return e.jsxs("div",{style:{border:"1px solid #eee",borderRadius:6,padding:10},children:[e.jsx("div",{children:e.jsx("strong",{children:a})}),e.jsxs("div",{children:["Status: ",(t==null?void 0:t.status)||"não consultado"]}),e.jsxs("div",{children:["Total: ",(t==null?void 0:t.total)!=null?j(t.total):"-"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>be(a),style:{marginTop:6},children:"Atualizar status"})]},a)})})]}),f==="conta"&&e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16},children:[e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Cadastro"}),e.jsxs("form",{onSubmit:Be,style:{display:"grid",gap:8},children:[e.jsx("input",{value:B.nome,onChange:a=>D(t=>({...t,nome:a.target.value})),placeholder:"Nome",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:B.email,onChange:a=>D(t=>({...t,email:a.target.value})),placeholder:"Email",type:"email",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:B.password,onChange:a=>D(t=>({...t,password:a.target.value})),placeholder:"Senha",type:"password",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-primary",type:"submit",disabled:se,children:"Cadastrar"})]})]}),e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Login"}),e.jsxs("form",{onSubmit:De,style:{display:"grid",gap:8},children:[e.jsx("input",{value:K.email,onChange:a=>W(t=>({...t,email:a.target.value})),placeholder:"Email",type:"email",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:K.password,onChange:a=>W(t=>({...t,password:a.target.value})),placeholder:"Senha",type:"password",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-primary",type:"submit",disabled:se,children:"Entrar"})]}),e.jsx("hr",{style:{margin:"12px 0"}}),e.jsx("h4",{style:{marginBottom:6},children:"Perfil"}),U?e.jsxs("div",{style:{display:"grid",gap:4},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Nome:"})," ",U.nome||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",U.email||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"ID:"})," ",U.id]}),e.jsx("button",{className:"btn-secondary",onClick:Fe,style:{marginTop:8},children:"Sair"})]}):e.jsx("div",{style:{color:"#666"},children:"Nenhum cliente autenticado."})]})]})]})}export{Ze as default};
