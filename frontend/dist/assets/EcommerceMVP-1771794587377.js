import{r as n,j as e}from"./vendor-react-1771794587377.js";import{a as h,L as Ae}from"./index-1771794587377.js";import{A as Te}from"./produtos-17717945873772.js";import"./vendor-utils-1771794587377.js";import"./vendor-icons-1771794587377.js";const C="ecommerce_customer_token",ue="ecommerce_customer_orders",he="ecommerce_customer_address";function y(r){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(r||0))}function ge(r){return Number((r==null?void 0:r.preco_venda)??(r==null?void 0:r.preco)??(r==null?void 0:r.preco_promocional)??0)}function ze(){var r;return(r=window==null?void 0:window.crypto)!=null&&r.randomUUID?window.crypto.randomUUID():`checkout-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Le(r){return Array.isArray(r)?r:Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r==null?void 0:r.itens)?r.itens:Array.isArray(r==null?void 0:r.produtos)?r.produtos:[]}function Me(){var ie,de,le,ce;const[r,x]=n.useState("loja"),[B,V]=n.useState(!1),[k,U]=n.useState([]),[w,me]=n.useState(""),[_,pe]=n.useState("todas"),[u,W]=n.useState(null),[G,E]=n.useState(!1),[J,Y]=n.useState(!1),[fe,H]=n.useState(!1),[c,N]=n.useState(localStorage.getItem(C)||""),[R,F]=n.useState(null),[A,T]=n.useState({email:"",password:"",nome:""}),[P,M]=n.useState({email:"",password:""}),[g,v]=n.useState({pedido_id:null,itens:[],subtotal:0,total:0}),[O,X]=n.useState(""),[j,q]=n.useState(null),[z,ye]=n.useState(""),[L,xe]=n.useState(localStorage.getItem(he)||""),[m,D]=n.useState(null),[I,K]=n.useState(null),[S,je]=n.useState(()=>{try{return JSON.parse(localStorage.getItem(ue)||"[]")}catch{return[]}}),[Q,Z]=n.useState({}),[ee,d]=n.useState(""),[ae,p]=n.useState(""),l=n.useMemo(()=>{try{return JSON.parse(localStorage.getItem("selectedTenant")||"null")}catch{return null}},[]),se=n.useMemo(()=>l!=null&&l.id?{"X-Tenant-ID":l.id}:{},[l]),b=n.useMemo(()=>c?{Authorization:`Bearer ${c}`}:{},[c]),be=n.useMemo(()=>{const a=k.map(s=>(s==null?void 0:s.categoria_nome)||(s==null?void 0:s.categoria)||"Sem categoria").filter(Boolean);return["todas",...Array.from(new Set(a))]},[k]),te=n.useMemo(()=>{const a=w.trim().toLowerCase();return k.filter(s=>{const t=String((s==null?void 0:s.nome)||"").toLowerCase(),o=(s==null?void 0:s.categoria_nome)||(s==null?void 0:s.categoria)||"Sem categoria";return(!a||t.includes(a))&&(_==="todas"||o===_)})},[k,w,_]);n.useEffect(()=>{re()},[]),n.useEffect(()=>{c&&(ve(),Se())},[c]);async function re(){var a,s;V(!0),d("");try{const t=await Te({limit:100,busca:w||void 0});U(Le(t==null?void 0:t.data))}catch(t){U([]),d(((s=(a=t==null?void 0:t.response)==null?void 0:a.data)==null?void 0:s.detail)||"Erro ao carregar produtos vendáveis")}finally{V(!1)}}async function ve(){if(c)try{const a=await h.get("/api/ecommerce/auth/me",{headers:b});F(a.data)}catch{F(null),N(""),localStorage.removeItem(C)}}async function Se(){var a,s;if(c){H(!0);try{const t=await h.get("/api/carrinho",{headers:b});v(t.data||{pedido_id:null,itens:[],subtotal:0,total:0})}catch(t){d(((s=(a=t==null?void 0:t.response)==null?void 0:a.data)==null?void 0:s.detail)||"Erro ao carregar carrinho")}finally{H(!1)}}}async function Ce(a){var s,t,o;if(a.preventDefault(),!(l!=null&&l.id)){d("Tenant não selecionado. Faça login no sistema e selecione uma empresa.");return}E(!0),d(""),p("");try{const i=await h.post("/api/ecommerce/auth/registrar",A,{headers:se}),f=(s=i==null?void 0:i.data)==null?void 0:s.access_token;if(!f)throw new Error("Token não retornado");localStorage.setItem(C,f),N(f),T({email:"",password:"",nome:""}),p("Cadastro realizado com sucesso."),x("loja")}catch(i){d(((o=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:o.detail)||"Erro ao cadastrar cliente")}finally{E(!1)}}async function ke(a){var s,t,o;if(a.preventDefault(),!(l!=null&&l.id)){d("Tenant não selecionado. Faça login no sistema e selecione uma empresa.");return}E(!0),d(""),p("");try{const i=await h.post("/api/ecommerce/auth/login",P,{headers:se}),f=(s=i==null?void 0:i.data)==null?void 0:s.access_token;if(!f)throw new Error("Token não retornado");localStorage.setItem(C,f),N(f),M({email:"",password:""}),p("Login realizado com sucesso."),x("loja")}catch(i){d(((o=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:o.detail)||"Erro ao realizar login")}finally{E(!1)}}function we(){F(null),N(""),v({pedido_id:null,itens:[],subtotal:0,total:0}),D(null),K(null),localStorage.removeItem(C),p("Sessão encerrada.")}async function oe(a){var s,t;if(!c){d("Faça login/cadastro do cliente para usar o carrinho."),x("conta");return}d("");try{const o=await h.post("/api/carrinho/adicionar",{produto_id:a.id,quantidade:1},{headers:b});v(o.data),p("Produto adicionado ao carrinho.")}catch(o){d(((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.detail)||"Erro ao adicionar no carrinho")}}async function $(a,s){var t,o;if(c){d("");try{if(s<=0){const f=await h.delete(`/api/carrinho/remover/${a}`,{headers:b});v(f.data);return}const i=await h.put(`/api/carrinho/atualizar/${a}`,{quantidade:s},{headers:b});v(i.data)}catch(i){d(((o=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:o.detail)||"Erro ao atualizar carrinho")}}}async function _e(a){var s,t;if(a.preventDefault(),!(!c||!O.trim())){d("");try{const o=await h.post("/api/carrinho/aplicar-cupom",{codigo:O.trim()},{headers:b});q(o.data),p("Cupom validado.")}catch(o){q(null),d(((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.detail)||"Cupom inválido")}}}async function Ee(a){var s,t;if(a.preventDefault(),!!c){d(""),D(null);try{const o=await h.get("/api/checkout/resumo",{headers:b,params:{cidade_destino:z,cupom:(j==null?void 0:j.codigo)||void 0}});D(o.data),p("Resumo de checkout calculado.")}catch(o){d(((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.detail)||"Erro ao calcular resumo do checkout")}}}async function Ne(){var a,s;if(c){Y(!0),d(""),p(""),K(null);try{const o=(await h.post("/api/checkout/finalizar",{cidade_destino:z,endereco_entrega:L||null,cupom:(j==null?void 0:j.codigo)||null},{headers:{...b,"Idempotency-Key":ze()}})).data;if(K(o),v({pedido_id:null,itens:[],subtotal:0,total:0}),D(null),q(null),X(""),L&&localStorage.setItem(he,L),o!=null&&o.pedido_id){const i=Array.from(new Set([o.pedido_id,...S]));je(i),localStorage.setItem(ue,JSON.stringify(i))}p("Pedido finalizado com sucesso."),x("pedidos")}catch(t){d(((s=(a=t==null?void 0:t.response)==null?void 0:a.data)==null?void 0:s.detail)||"Erro ao finalizar checkout")}finally{Y(!1)}}}async function ne(a){if(!(!c||!a))try{const s=await h.get(`/api/checkout/pedido/${a}/status`,{headers:b});Z(t=>({...t,[a]:s.data}))}catch(s){Z(t=>{var o,i;return{...t,[a]:{status:"erro",detail:((i=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:i.detail)||"Erro ao consultar pedido"}}})}}n.useEffect(()=>{!c||r!=="pedidos"||S.slice(0,10).forEach(a=>{Q[a]||ne(a)})},[r,c,S]);const Re=Number((g==null?void 0:g.total)||0);return e.jsxs("div",{className:"page",children:[e.jsx("h1",{children:"E-commerce MVP"}),e.jsx("p",{style:{color:"#666",marginBottom:16},children:"Loja, carrinho, checkout e conta do cliente no fluxo do e-commerce."}),e.jsxs("div",{style:{marginBottom:12,color:l!=null&&l.id?"#0a7d32":"#b00020"},children:["Tenant: ",(l==null?void 0:l.name)||"não selecionado"," (",(l==null?void 0:l.id)||"-",")"]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginBottom:16},children:[e.jsx("button",{className:"btn-secondary",onClick:()=>x("loja"),children:"Loja"}),e.jsx("button",{className:"btn-secondary",onClick:()=>x("carrinho"),children:"Carrinho"}),e.jsx("button",{className:"btn-secondary",onClick:()=>x("checkout"),children:"Checkout"}),e.jsx("button",{className:"btn-secondary",onClick:()=>x("pedidos"),children:"Meus pedidos"}),e.jsx("button",{className:"btn-secondary",onClick:()=>x("conta"),children:"Conta"})]}),ee&&e.jsx("div",{style:{background:"#ffe8e8",color:"#8c0000",padding:10,borderRadius:6,marginBottom:12},children:ee}),ae&&e.jsx("div",{style:{background:"#e8fff0",color:"#0a7d32",padding:10,borderRadius:6,marginBottom:12},children:ae}),r==="loja"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:12},children:[e.jsx("input",{value:w,onChange:a=>me(a.target.value),placeholder:"Buscar produto...",style:{flex:1,padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("select",{value:_,onChange:a=>pe(a.target.value),style:{padding:8,border:"1px solid #ddd",borderRadius:6},children:be.map(a=>e.jsx("option",{value:a,children:a},a))}),e.jsx("button",{className:"btn-secondary",onClick:re,disabled:B,children:B?"Carregando...":"Atualizar"})]}),e.jsxs("div",{style:{display:"grid",gap:8},children:[te.map(a=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",border:"1px solid #eee",borderRadius:6,padding:10},children:[e.jsxs("div",{children:[e.jsx("strong",{children:a.nome}),e.jsxs("div",{style:{fontSize:12,color:"#666"},children:["Categoria: ",(a==null?void 0:a.categoria_nome)||(a==null?void 0:a.categoria)||"Sem categoria"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>W(a),style:{marginTop:6},children:"Ver produto"})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{marginBottom:6},children:y(ge(a))}),e.jsx("button",{className:"btn-primary",onClick:()=>oe(a),children:"Adicionar"})]})]},a.id)),!B&&te.length===0&&e.jsxs("div",{style:{color:"#666",padding:12,display:"grid",gap:10},children:[e.jsx("div",{children:"Nenhum produto encontrado para o filtro atual."}),e.jsxs("div",{style:{fontSize:13},children:["Cadastre produtos em ",e.jsx(Ae,{to:"/produtos/novo",style:{color:"#2563eb"},children:"Produtos > Novo"}),"."]})]})]}),u&&e.jsxs("div",{style:{marginTop:14,border:"1px solid #e2e8f0",borderRadius:8,padding:12,background:"#f8fafc"},children:[e.jsx("h3",{style:{marginTop:0},children:u.nome}),e.jsxs("div",{children:["Preço: ",e.jsx("strong",{children:y(ge(u))})]}),e.jsxs("div",{children:["Categoria: ",(u==null?void 0:u.categoria_nome)||(u==null?void 0:u.categoria)||"Sem categoria"]}),e.jsxs("div",{children:["Estoque e-commerce: ",(u==null?void 0:u.estoque_ecommerce)??0]}),e.jsxs("div",{style:{marginTop:8},children:[e.jsx("button",{className:"btn-primary",onClick:()=>oe(u),children:"Adicionar ao carrinho"}),e.jsx("button",{className:"btn-secondary",onClick:()=>W(null),style:{marginLeft:8},children:"Fechar"})]})]})]}),r==="carrinho"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Carrinho"}),fe?e.jsx("div",{children:"Carregando carrinho..."}):(ie=g==null?void 0:g.itens)!=null&&ie.length?e.jsxs("div",{style:{display:"grid",gap:8},children:[g.itens.map(a=>e.jsxs("div",{style:{border:"1px solid #eee",borderRadius:6,padding:8},children:[e.jsx("div",{style:{fontWeight:600},children:a.nome}),e.jsx("div",{style:{fontSize:12,color:"#666"},children:y(a.preco_unitario)}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:6},children:[e.jsx("button",{className:"btn-secondary",onClick:()=>$(a.item_id,a.quantidade-1),children:"-"}),e.jsx("span",{children:a.quantidade}),e.jsx("button",{className:"btn-secondary",onClick:()=>$(a.item_id,a.quantidade+1),children:"+"}),e.jsx("button",{className:"btn-secondary",onClick:()=>$(a.item_id,0),children:"Remover"})]})]},a.item_id)),e.jsxs("div",{style:{marginTop:8,fontWeight:700},children:["Total: ",y(Re)]})]}):e.jsx("div",{style:{color:"#666"},children:"Carrinho vazio"}),e.jsxs("form",{onSubmit:_e,style:{marginTop:12,display:"flex",gap:8},children:[e.jsx("input",{value:O,onChange:a=>X(a.target.value),placeholder:"Cupom",style:{flex:1,padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-secondary",type:"submit",children:"Aplicar"})]}),j&&e.jsxs("div",{style:{marginTop:8,color:"#0a7d32"},children:["Cupom ",j.codigo,": -",y(j.desconto)]})]}),r==="checkout"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8,display:"grid",gap:10},children:[e.jsx("h3",{style:{marginTop:0},children:"Checkout"}),e.jsxs("form",{onSubmit:Ee,style:{display:"grid",gap:8},children:[e.jsx("input",{value:z,onChange:a=>ye(a.target.value),placeholder:"Cidade de destino",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:L,onChange:a=>xe(a.target.value),placeholder:"Endereço de entrega",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-secondary",type:"submit",children:"Calcular resumo"})]}),m&&e.jsxs("div",{style:{background:"#f8fafc",border:"1px solid #e2e8f0",borderRadius:8,padding:10},children:[e.jsxs("div",{children:["Itens: ",m.itens_count]}),e.jsxs("div",{children:["Subtotal: ",y(m.subtotal)]}),e.jsxs("div",{children:["Frete: ",y((de=m==null?void 0:m.frete)==null?void 0:de.valor_frete)]}),e.jsxs("div",{children:["Desconto: ",y((le=m==null?void 0:m.cupom)==null?void 0:le.desconto)]}),e.jsxs("div",{style:{fontWeight:700},children:["Total: ",y(m.total)]})]}),e.jsx("button",{className:"btn-primary",onClick:Ne,disabled:J||!z||!((ce=g==null?void 0:g.itens)!=null&&ce.length),children:J?"Finalizando...":"Finalizar pedido"}),(I==null?void 0:I.pedido_id)&&e.jsxs("div",{style:{background:"#e8fff0",color:"#0a7d32",padding:10,borderRadius:6},children:["Pedido confirmado: ",e.jsx("strong",{children:I.pedido_id})]})]}),r==="pedidos"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Meus pedidos"}),S.length===0?e.jsx("div",{style:{color:"#666"},children:"Nenhum pedido registrado nesta sessão."}):e.jsx("div",{style:{display:"grid",gap:8},children:S.map(a=>{const s=Q[a];return e.jsxs("div",{style:{border:"1px solid #eee",borderRadius:6,padding:10},children:[e.jsx("div",{children:e.jsx("strong",{children:a})}),e.jsxs("div",{children:["Status: ",(s==null?void 0:s.status)||"não consultado"]}),e.jsxs("div",{children:["Total: ",(s==null?void 0:s.total)!=null?y(s.total):"-"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>ne(a),style:{marginTop:6},children:"Atualizar status"})]},a)})})]}),r==="conta"&&e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16},children:[e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Cadastro"}),e.jsxs("form",{onSubmit:Ce,style:{display:"grid",gap:8},children:[e.jsx("input",{value:A.nome,onChange:a=>T(s=>({...s,nome:a.target.value})),placeholder:"Nome",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:A.email,onChange:a=>T(s=>({...s,email:a.target.value})),placeholder:"Email",type:"email",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:A.password,onChange:a=>T(s=>({...s,password:a.target.value})),placeholder:"Senha",type:"password",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-primary",type:"submit",disabled:G,children:"Cadastrar"})]})]}),e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Login"}),e.jsxs("form",{onSubmit:ke,style:{display:"grid",gap:8},children:[e.jsx("input",{value:P.email,onChange:a=>M(s=>({...s,email:a.target.value})),placeholder:"Email",type:"email",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:P.password,onChange:a=>M(s=>({...s,password:a.target.value})),placeholder:"Senha",type:"password",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-primary",type:"submit",disabled:G,children:"Entrar"})]}),e.jsx("hr",{style:{margin:"12px 0"}}),e.jsx("h4",{style:{marginBottom:6},children:"Perfil"}),R?e.jsxs("div",{style:{display:"grid",gap:4},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Nome:"})," ",R.nome||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",R.email||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"ID:"})," ",R.id]}),e.jsx("button",{className:"btn-secondary",onClick:we,style:{marginTop:8},children:"Sair"})]}):e.jsx("div",{style:{color:"#666"},children:"Nenhum cliente autenticado."})]})]})]})}export{Me as default};
