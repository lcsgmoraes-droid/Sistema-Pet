import{u as Ie,p as Be,r as n,j as e}from"./vendor-react-1771886774859.js";import{a as De}from"./vendor-utils-1771886774859.js";const Pe="/api",Fe=Pe,u=De.create({baseURL:Fe,timeout:15e3,headers:{"Content-Type":"application/json"}});u.interceptors.request.use(t=>{const _=String(t.baseURL||""),m=String(t.url||"");return _.endsWith("/api")&&m.startsWith("/api/")&&(t.url=m.replace(/^\/api/,"")),t});const R="ecommerce_customer_token",ge="ecommerce_customer_orders",fe="ecommerce_customer_address";function j(t){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(t||0))}function ye(t){return Number((t==null?void 0:t.preco_venda)??(t==null?void 0:t.preco)??(t==null?void 0:t.preco_promocional)??0)}function Me(){var t;return(t=window==null?void 0:window.crypto)!=null&&t.randomUUID?window.crypto.randomUUID():`checkout-${Date.now()}-${Math.random().toString(16).slice(2)}`}function qe(t){return Array.isArray(t)?t:Array.isArray(t==null?void 0:t.items)?t.items:Array.isArray(t==null?void 0:t.itens)?t.itens:Array.isArray(t==null?void 0:t.produtos)?t.produtos:[]}function We(){var ue,he,me,pe;const t=Ie(),_=Be(),[m,x]=n.useState("loja"),[F,H]=n.useState(!1),[w,M]=n.useState([]),[E,je]=n.useState(""),[N,xe]=n.useState("todas"),[h,J]=n.useState(null),[Q,T]=n.useState(!1),[X,Z]=n.useState(!1),[be,ee]=n.useState(!1),[c,L]=n.useState(localStorage.getItem(R)||""),[A,q]=n.useState(null),[z,U]=n.useState({email:"",password:"",nome:""}),[O,K]=n.useState({email:"",password:""}),[p,C]=n.useState({pedido_id:null,itens:[],subtotal:0,total:0}),[W,ae]=n.useState(""),[b,$]=n.useState(null),[I,ve]=n.useState(""),[B,Se]=n.useState(localStorage.getItem(fe)||""),[g,D]=n.useState(null),[P,V]=n.useState(null),[k,Ce]=n.useState(()=>{try{return JSON.parse(localStorage.getItem(ge)||"[]")}catch{return[]}}),[se,re]=n.useState({}),[te,l]=n.useState(""),[oe,f]=n.useState(""),[d,G]=n.useState(null),S=n.useMemo(()=>new URLSearchParams(t.search).get("tenant")||_.tenantId||"",[t.search,_.tenantId]),ne=n.useMemo(()=>d!=null&&d.id?{"X-Tenant-ID":d.id}:{},[d==null?void 0:d.id]),v=n.useMemo(()=>c?{Authorization:`Bearer ${c}`}:{},[c]),ke=n.useMemo(()=>{const a=w.map(s=>(s==null?void 0:s.categoria_nome)||(s==null?void 0:s.categoria)||"Sem categoria").filter(Boolean);return["todas",...Array.from(new Set(a))]},[w]),ie=n.useMemo(()=>{const a=E.trim().toLowerCase();return w.filter(s=>{const r=String((s==null?void 0:s.nome)||"").toLowerCase(),o=(s==null?void 0:s.categoria_nome)||(s==null?void 0:s.categoria)||"Sem categoria";return(!a||r.includes(a))&&(N==="todas"||o===N)})},[w,E,N]);n.useEffect(()=>{if(!S){M([]),G(null),l("Loja não informada na URL. Use /slug-da-loja.");return}Re(),de()},[S]),n.useEffect(()=>{c&&(_e(),we())},[c]);async function Re(){var a,s;try{const r=await u.get("/api/ecommerce/tenant-context",{params:{tenant:S}});G((r==null?void 0:r.data)||null)}catch(r){G(null),l(((s=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:s.detail)||"Loja inválida para e-commerce")}}async function de(){var a,s;if(S){H(!0),l("");try{const r=await u.get("/api/ecommerce/produtos",{params:{tenant:S,limit:100,busca:E||void 0}});M(qe(r==null?void 0:r.data))}catch(r){M([]),l(((s=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:s.detail)||"Erro ao carregar produtos vendáveis")}finally{H(!1)}}}async function _e(){if(c)try{const a=await u.get("/api/ecommerce/auth/me",{headers:v});q(a.data)}catch{q(null),L(""),localStorage.removeItem(R)}}async function we(){var a,s;if(c){ee(!0);try{const r=await u.get("/api/carrinho",{headers:v});C(r.data||{pedido_id:null,itens:[],subtotal:0,total:0})}catch(r){l(((s=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:s.detail)||"Erro ao carregar carrinho")}finally{ee(!1)}}}async function Ee(a){var s,r,o;if(a.preventDefault(),!(d!=null&&d.id)){l("Loja não identificada na URL.");return}T(!0),l(""),f("");try{const i=await u.post("/api/ecommerce/auth/registrar",z,{headers:ne}),y=(s=i==null?void 0:i.data)==null?void 0:s.access_token;if(!y)throw new Error("Token não retornado");localStorage.setItem(R,y),L(y),U({email:"",password:"",nome:""}),f("Cadastro realizado com sucesso."),x("loja")}catch(i){l(((o=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:o.detail)||"Erro ao cadastrar cliente")}finally{T(!1)}}async function Ne(a){var s,r,o;if(a.preventDefault(),!(d!=null&&d.id)){l("Loja não identificada na URL.");return}T(!0),l(""),f("");try{const i=await u.post("/api/ecommerce/auth/login",O,{headers:ne}),y=(s=i==null?void 0:i.data)==null?void 0:s.access_token;if(!y)throw new Error("Token não retornado");localStorage.setItem(R,y),L(y),K({email:"",password:""}),f("Login realizado com sucesso."),x("loja")}catch(i){l(((o=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:o.detail)||"Erro ao realizar login")}finally{T(!1)}}function Te(){q(null),L(""),C({pedido_id:null,itens:[],subtotal:0,total:0}),D(null),V(null),localStorage.removeItem(R),f("Sessão encerrada.")}async function le(a){var s,r;if(!c){l("Faça login/cadastro do cliente para usar o carrinho."),x("conta");return}l("");try{const o=await u.post("/api/carrinho/adicionar",{produto_id:a.id,quantidade:1},{headers:v});C(o.data),f("Produto adicionado ao carrinho.")}catch(o){l(((r=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:r.detail)||"Erro ao adicionar no carrinho")}}async function Y(a,s){var r,o;if(c){l("");try{if(s<=0){const y=await u.delete(`/api/carrinho/remover/${a}`,{headers:v});C(y.data);return}const i=await u.put(`/api/carrinho/atualizar/${a}`,{quantidade:s},{headers:v});C(i.data)}catch(i){l(((o=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:o.detail)||"Erro ao atualizar carrinho")}}}async function Le(a){var s,r;if(a.preventDefault(),!(!c||!W.trim())){l("");try{const o=await u.post("/api/carrinho/aplicar-cupom",{codigo:W.trim()},{headers:v});$(o.data),f("Cupom validado.")}catch(o){$(null),l(((r=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:r.detail)||"Cupom inválido")}}}async function Ae(a){var s,r;if(a.preventDefault(),!!c){l(""),D(null);try{const o=await u.get("/api/checkout/resumo",{headers:v,params:{cidade_destino:I,cupom:(b==null?void 0:b.codigo)||void 0}});D(o.data),f("Resumo de checkout calculado.")}catch(o){l(((r=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:r.detail)||"Erro ao calcular resumo do checkout")}}}async function ze(){var a,s;if(c){Z(!0),l(""),f(""),V(null);try{const o=(await u.post("/api/checkout/finalizar",{cidade_destino:I,endereco_entrega:B||null,cupom:(b==null?void 0:b.codigo)||null},{headers:{...v,"Idempotency-Key":Me()}})).data;if(V(o),C({pedido_id:null,itens:[],subtotal:0,total:0}),D(null),$(null),ae(""),B&&localStorage.setItem(fe,B),o!=null&&o.pedido_id){const i=Array.from(new Set([o.pedido_id,...k]));Ce(i),localStorage.setItem(ge,JSON.stringify(i))}f("Pedido finalizado com sucesso."),x("pedidos")}catch(r){l(((s=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:s.detail)||"Erro ao finalizar checkout")}finally{Z(!1)}}}async function ce(a){if(!(!c||!a))try{const s=await u.get(`/api/checkout/pedido/${a}/status`,{headers:v});re(r=>({...r,[a]:s.data}))}catch(s){re(r=>{var o,i;return{...r,[a]:{status:"erro",detail:((i=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:i.detail)||"Erro ao consultar pedido"}}})}}n.useEffect(()=>{!c||m!=="pedidos"||k.slice(0,10).forEach(a=>{se[a]||ce(a)})},[m,c,k]);const Ue=Number((p==null?void 0:p.total)||0);return e.jsxs("div",{className:"page",children:[e.jsx("h1",{children:"E-commerce MVP"}),e.jsx("p",{style:{color:"#666",marginBottom:16},children:"Loja, carrinho, checkout e conta do cliente no fluxo do e-commerce."}),e.jsxs("div",{style:{marginBottom:12,color:d!=null&&d.id?"#0a7d32":"#b00020"},children:["Loja: ",(d==null?void 0:d.name)||"não identificada"," (",(d==null?void 0:d.ecommerce_slug)||S||"-",")"]}),(d==null?void 0:d.storefront_path)&&e.jsxs("div",{style:{marginBottom:12,color:"#4b5563"},children:["URL da loja: ",d.storefront_path]}),!S&&e.jsx("div",{style:{marginBottom:12,color:"#b00020"},children:"Use a URL no formato: /slug-da-loja"}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginBottom:16},children:[e.jsx("button",{className:"btn-secondary",onClick:()=>x("loja"),children:"Loja"}),e.jsx("button",{className:"btn-secondary",onClick:()=>x("carrinho"),children:"Carrinho"}),e.jsx("button",{className:"btn-secondary",onClick:()=>x("checkout"),children:"Checkout"}),e.jsx("button",{className:"btn-secondary",onClick:()=>x("pedidos"),children:"Meus pedidos"}),e.jsx("button",{className:"btn-secondary",onClick:()=>x("conta"),children:"Conta"})]}),te&&e.jsx("div",{style:{background:"#ffe8e8",color:"#8c0000",padding:10,borderRadius:6,marginBottom:12},children:te}),oe&&e.jsx("div",{style:{background:"#e8fff0",color:"#0a7d32",padding:10,borderRadius:6,marginBottom:12},children:oe}),m==="loja"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:12},children:[e.jsx("input",{value:E,onChange:a=>je(a.target.value),placeholder:"Buscar produto...",style:{flex:1,padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("select",{value:N,onChange:a=>xe(a.target.value),style:{padding:8,border:"1px solid #ddd",borderRadius:6},children:ke.map(a=>e.jsx("option",{value:a,children:a},a))}),e.jsx("button",{className:"btn-secondary",onClick:de,disabled:F,children:F?"Carregando...":"Atualizar"})]}),e.jsxs("div",{style:{display:"grid",gap:8},children:[ie.map(a=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",border:"1px solid #eee",borderRadius:6,padding:10},children:[e.jsxs("div",{children:[e.jsx("strong",{children:a.nome}),e.jsxs("div",{style:{fontSize:12,color:"#666"},children:["Categoria: ",(a==null?void 0:a.categoria_nome)||(a==null?void 0:a.categoria)||"Sem categoria"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>J(a),style:{marginTop:6},children:"Ver produto"})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{marginBottom:6},children:j(ye(a))}),e.jsx("button",{className:"btn-primary",onClick:()=>le(a),children:"Adicionar"})]})]},a.id)),!F&&ie.length===0&&e.jsx("div",{style:{color:"#666",padding:12,display:"grid",gap:10},children:e.jsx("div",{children:"Nenhum produto encontrado para o filtro atual."})})]}),h&&e.jsxs("div",{style:{marginTop:14,border:"1px solid #e2e8f0",borderRadius:8,padding:12,background:"#f8fafc"},children:[e.jsx("h3",{style:{marginTop:0},children:h.nome}),e.jsxs("div",{children:["Preço: ",e.jsx("strong",{children:j(ye(h))})]}),e.jsxs("div",{children:["Categoria: ",(h==null?void 0:h.categoria_nome)||(h==null?void 0:h.categoria)||"Sem categoria"]}),e.jsxs("div",{children:["Estoque e-commerce: ",(h==null?void 0:h.estoque_ecommerce)??0]}),e.jsxs("div",{style:{marginTop:8},children:[e.jsx("button",{className:"btn-primary",onClick:()=>le(h),children:"Adicionar ao carrinho"}),e.jsx("button",{className:"btn-secondary",onClick:()=>J(null),style:{marginLeft:8},children:"Fechar"})]})]})]}),m==="carrinho"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Carrinho"}),be?e.jsx("div",{children:"Carregando carrinho..."}):(ue=p==null?void 0:p.itens)!=null&&ue.length?e.jsxs("div",{style:{display:"grid",gap:8},children:[p.itens.map(a=>e.jsxs("div",{style:{border:"1px solid #eee",borderRadius:6,padding:8},children:[e.jsx("div",{style:{fontWeight:600},children:a.nome}),e.jsx("div",{style:{fontSize:12,color:"#666"},children:j(a.preco_unitario)}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:6},children:[e.jsx("button",{className:"btn-secondary",onClick:()=>Y(a.item_id,a.quantidade-1),children:"-"}),e.jsx("span",{children:a.quantidade}),e.jsx("button",{className:"btn-secondary",onClick:()=>Y(a.item_id,a.quantidade+1),children:"+"}),e.jsx("button",{className:"btn-secondary",onClick:()=>Y(a.item_id,0),children:"Remover"})]})]},a.item_id)),e.jsxs("div",{style:{marginTop:8,fontWeight:700},children:["Total: ",j(Ue)]})]}):e.jsx("div",{style:{color:"#666"},children:"Carrinho vazio"}),e.jsxs("form",{onSubmit:Le,style:{marginTop:12,display:"flex",gap:8},children:[e.jsx("input",{value:W,onChange:a=>ae(a.target.value),placeholder:"Cupom",style:{flex:1,padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-secondary",type:"submit",children:"Aplicar"})]}),b&&e.jsxs("div",{style:{marginTop:8,color:"#0a7d32"},children:["Cupom ",b.codigo,": -",j(b.desconto)]})]}),m==="checkout"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8,display:"grid",gap:10},children:[e.jsx("h3",{style:{marginTop:0},children:"Checkout"}),e.jsxs("form",{onSubmit:Ae,style:{display:"grid",gap:8},children:[e.jsx("input",{value:I,onChange:a=>ve(a.target.value),placeholder:"Cidade de destino",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:B,onChange:a=>Se(a.target.value),placeholder:"Endereço de entrega",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-secondary",type:"submit",children:"Calcular resumo"})]}),g&&e.jsxs("div",{style:{background:"#f8fafc",border:"1px solid #e2e8f0",borderRadius:8,padding:10},children:[e.jsxs("div",{children:["Itens: ",g.itens_count]}),e.jsxs("div",{children:["Subtotal: ",j(g.subtotal)]}),e.jsxs("div",{children:["Frete: ",j((he=g==null?void 0:g.frete)==null?void 0:he.valor_frete)]}),e.jsxs("div",{children:["Desconto: ",j((me=g==null?void 0:g.cupom)==null?void 0:me.desconto)]}),e.jsxs("div",{style:{fontWeight:700},children:["Total: ",j(g.total)]})]}),e.jsx("button",{className:"btn-primary",onClick:ze,disabled:X||!I||!((pe=p==null?void 0:p.itens)!=null&&pe.length),children:X?"Finalizando...":"Finalizar pedido"}),(P==null?void 0:P.pedido_id)&&e.jsxs("div",{style:{background:"#e8fff0",color:"#0a7d32",padding:10,borderRadius:6},children:["Pedido confirmado: ",e.jsx("strong",{children:P.pedido_id})]})]}),m==="pedidos"&&e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Meus pedidos"}),k.length===0?e.jsx("div",{style:{color:"#666"},children:"Nenhum pedido registrado nesta sessão."}):e.jsx("div",{style:{display:"grid",gap:8},children:k.map(a=>{const s=se[a];return e.jsxs("div",{style:{border:"1px solid #eee",borderRadius:6,padding:10},children:[e.jsx("div",{children:e.jsx("strong",{children:a})}),e.jsxs("div",{children:["Status: ",(s==null?void 0:s.status)||"não consultado"]}),e.jsxs("div",{children:["Total: ",(s==null?void 0:s.total)!=null?j(s.total):"-"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>ce(a),style:{marginTop:6},children:"Atualizar status"})]},a)})})]}),m==="conta"&&e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16},children:[e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Cadastro"}),e.jsxs("form",{onSubmit:Ee,style:{display:"grid",gap:8},children:[e.jsx("input",{value:z.nome,onChange:a=>U(s=>({...s,nome:a.target.value})),placeholder:"Nome",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:z.email,onChange:a=>U(s=>({...s,email:a.target.value})),placeholder:"Email",type:"email",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:z.password,onChange:a=>U(s=>({...s,password:a.target.value})),placeholder:"Senha",type:"password",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-primary",type:"submit",disabled:Q,children:"Cadastrar"})]})]}),e.jsxs("div",{style:{background:"#fff",padding:16,borderRadius:8},children:[e.jsx("h3",{style:{marginTop:0},children:"Login"}),e.jsxs("form",{onSubmit:Ne,style:{display:"grid",gap:8},children:[e.jsx("input",{value:O.email,onChange:a=>K(s=>({...s,email:a.target.value})),placeholder:"Email",type:"email",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("input",{value:O.password,onChange:a=>K(s=>({...s,password:a.target.value})),placeholder:"Senha",type:"password",style:{padding:8,border:"1px solid #ddd",borderRadius:6}}),e.jsx("button",{className:"btn-primary",type:"submit",disabled:Q,children:"Entrar"})]}),e.jsx("hr",{style:{margin:"12px 0"}}),e.jsx("h4",{style:{marginBottom:6},children:"Perfil"}),A?e.jsxs("div",{style:{display:"grid",gap:4},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Nome:"})," ",A.nome||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",A.email||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"ID:"})," ",A.id]}),e.jsx("button",{className:"btn-secondary",onClick:Te,style:{marginTop:8},children:"Sair"})]}):e.jsx("div",{style:{color:"#666"},children:"Nenhum cliente autenticado."})]})]})]})}export{We as default};
